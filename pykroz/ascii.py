from typing import Tuple, cast

from pygame.image import load
from colors import Colors
from functools import reduce

from pygame import Color, Rect, Surface
from pygame.freetype import Font, SysFont
import pygame.locals

class ASCII:
    def __init__(self, width: int, height: int, surface: Surface):
        self.width = width
        self.height = height
        self.surface = surface
        self.mid = Surface((width, height))

    def from_font(font: Font):
        def get_dimensions(t: Tuple[int, int, str], current_character: str) -> Tuple[int, int, str]:
            biggest_width, biggest_height, biggest_char = t
            [metrics] = font.get_metrics(current_character)
            (min_x, max_x, min_y, max_y, _, _) = metrics
            character_width = max_x - min_x
            character_height = max_y - min_y
            if biggest_height >= character_height:
                return max(biggest_width, character_width), biggest_height, biggest_char
            else:
                print(min_y, max_y)
                return max(biggest_width, character_width), character_height, current_character
                
        (width, height, biggest) = reduce(get_dimensions, ASCII.Char.values(), (0, 0, ''))
        print(biggest, height)
        surface = Surface((width * len(ASCII.Char), height))
        surface.set_colorkey(Colors.Black)
        for i in ASCII.Char:
            c = ASCII.Char[i]
            [m] = font.get_metrics(c)
            (min_x, _, _, max_y, _, _) = m
            (x, y) = (i * width + min_x), height - max_y
            font.render_to(surface, (x, y), c, fgcolor = Colors.White)
        return ASCII(width, height, surface)
        

    def from_font_file(filename: str, size: int = 12):
        font = Font(filename, size)
        return ASCII.from_font(font)

    def from_system_font(size: int = 12):
        font = cast(Font, SysFont(['Consolas', 'Menlo', 'Monaco', '\'Droid Sans Mono\''], size))
        return ASCII.from_font(font)

    def from_bitmap_font(filename: str, tileSize: Tuple[int, int]):
        font_surface = load(filename)
        (width, height) = tileSize
        surface = Surface((width * len(ASCII.Char), height))
        image_width_in_tiles = font_surface.get_width() // width
        image_height_in_tiles = font_surface.get_height() // height

        for x in range(image_width_in_tiles):
            for y in range(image_height_in_tiles):
                surface.blit(font_surface, ((x * image_width_in_tiles + y) * width, 0), Rect(x * width, y * height, width, height))

        return ASCII(width, height, surface)

    def draw(self, code: int, x: int, y: int, fgcolor: Color, bgColor: Color, target: Surface):
        self.mid.fill(bgColor)
        target.blit(
            self.mid,
            (x, y),
        )
        self.mid.fill(fgcolor)
        self.mid.blit(self.surface, (0, 0), Rect(code * self.width, 0, self.width, self.height), special_flags=pygame.locals.BLEND_RGB_MULT)
        target.blit(
            self.mid,
            (x, y),
        )

    Char = {
        0:   '\u0020',
        1:   '\u263A',
        2:   '\u263B',
        3:   '\u2665',
        4:   '\u2666',
        5:   '\u2663',
        6:   '\u2660',
        7:   '\u2022',
        8:   '\u25D8',
        9:   '\u25CB',
        10:  '\u25D9',
        11:  '\u2642',
        12:  '\u2640',
        13:  '\u266A',
        14:  '\u266B',
        15:  '\u263C',
        16:  '\u25BA',
        17:  '\u25C4',
        18:  '\u2195',
        19:  '\u203C',
        20:  '\u00B6',
        21:  '\u00A7',
        22:  '\u25AC',
        23:  '\u21A8',
        24:  '\u2191',
        25:  '\u2193',
        26:  '\u2192',
        27:  '\u2190',
        28:  '\u221F',
        29:  '\u2194',
        30:  '\u25B2',
        31:  '\u25BC',
        32:  '\u0020',
        33:  '\u0021',
        34:  '\u0022',
        35:  '\u0023',
        36:  '\u0024',
        37:  '\u0025',
        38:  '\u0026',
        39:  '\u0027',
        40:  '\u0028',
        41:  '\u0029',
        42:  '\u002A',
        43:  '\u002B',
        44:  '\u002C',
        45:  '\u002D',
        46:  '\u002E',
        47:  '\u002F',
        48:  '\u0030',
        49:  '\u0031',
        50:  '\u0032',
        51:  '\u0033',
        52:  '\u0034',
        53:  '\u0035',
        54:  '\u0036',
        55:  '\u0037',
        56:  '\u0038',
        57:  '\u0039',
        58:  '\u003A',
        59:  '\u003B',
        60:  '\u003C',
        61:  '\u003D',
        62:  '\u003E',
        63:  '\u003F',
        64:  '\u0040',
        65:  '\u0041',
        66:  '\u0042',
        67:  '\u0043',
        68:  '\u0044',
        69:  '\u0045',
        70:  '\u0046',
        71:  '\u0047',
        72:  '\u0048',
        73:  '\u0049',
        74:  '\u004A',
        75:  '\u004B',
        76:  '\u004C',
        77:  '\u004D',
        78:  '\u004E',
        79:  '\u004F',
        80:  '\u0050',
        81:  '\u0051',
        82:  '\u0052',
        83:  '\u0053',
        84:  '\u0054',
        85:  '\u0055',
        86:  '\u0056',
        87:  '\u0057',
        88:  '\u0058',
        89:  '\u0059',
        90:  '\u005A',
        91:  '\u005B',
        92:  '\u005C',
        93:  '\u005D',
        94:  '\u005E',
        95:  '\u005F',
        96:  '\u0060',
        97:  '\u0061',
        98:  '\u0062',
        99:  '\u0063',
        100: '\u0064',
        101: '\u0065',
        102: '\u0066',
        103: '\u0067',
        104: '\u0068',
        105: '\u0069',
        106: '\u006A',
        107: '\u006B',
        108: '\u006C',
        109: '\u006D',
        110: '\u006E',
        111: '\u006F',
        112: '\u0070',
        113: '\u0071',
        114: '\u0072',
        115: '\u0073',
        116: '\u0074',
        117: '\u0075',
        118: '\u0076',
        119: '\u0077',
        120: '\u0078',
        121: '\u0079',
        122: '\u007A',
        123: '\u007B',
        124: '\u007C',
        125: '\u007D',
        126: '\u007E',
        127: '\u2302',
        128: '\u00C7',
        129: '\u00FC',
        130: '\u00E9',
        131: '\u00E2',
        132: '\u00E4',
        133: '\u00E0',
        134: '\u00E5',
        135: '\u00E7',
        136: '\u00EA',
        137: '\u00EB',
        138: '\u00E8',
        139: '\u00EF',
        140: '\u00EE',
        141: '\u00EC',
        142: '\u00C4',
        143: '\u00C5',
        144: '\u00C9',
        145: '\u00E6',
        146: '\u00C6',
        147: '\u00F4',
        148: '\u00F6',
        149: '\u00F2',
        150: '\u00FB',
        151: '\u00F9',
        152: '\u00FF',
        153: '\u00D6',
        154: '\u00DC',
        155: '\u00A2',
        156: '\u00A3',
        157: '\u00A5',
        158: '\u20A7',
        159: '\u0192',
        160: '\u00E1',
        161: '\u00ED',
        162: '\u00F3',
        163: '\u00FA',
        164: '\u00F1',
        165: '\u00D1',
        166: '\u00AA',
        167: '\u00BA',
        168: '\u00BF',
        169: '\u2310',
        170: '\u00AC',
        171: '\u00BD',
        172: '\u00BC',
        173: '\u00A1',
        174: '\u00AB',
        175: '\u00BB',
        176: '\u2591',
        177: '\u2592',
        178: '\u2593',
        179: '\u2502',
        180: '\u2524',
        181: '\u2561',
        182: '\u2562',
        183: '\u2556',
        184: '\u2555',
        185: '\u2563',
        186: '\u2551',
        187: '\u2557',
        188: '\u255D',
        189: '\u255C',
        190: '\u255B',
        191: '\u2510',
        192: '\u2514',
        193: '\u2534',
        194: '\u252C',
        195: '\u251C',
        196: '\u2500',
        197: '\u253C',
        198: '\u255E',
        199: '\u255F',
        200: '\u255A',
        201: '\u2554',
        202: '\u2569',
        203: '\u2566',
        204: '\u2560',
        205: '\u2550',
        206: '\u256C',
        207: '\u2567',
        208: '\u2568',
        209: '\u2564',
        210: '\u2565',
        211: '\u2559',
        212: '\u2558',
        213: '\u2552',
        214: '\u2553',
        215: '\u256B',
        216: '\u256A',
        217: '\u2518',
        218: '\u250C',
        219: '\u2588',
        220: '\u2584',
        221: '\u258C',
        222: '\u2590',
        223: '\u2580',
        224: '\u03B1',
        225: '\u00DF',
        226: '\u0393',
        227: '\u03C0',
        228: '\u03A3',
        229: '\u03C3',
        230: '\u00B5',
        231: '\u03C4',
        232: '\u03A6',
        233: '\u0398',
        234: '\u03A9',
        235: '\u03B4',
        236: '\u221E',
        237: '\u03C6',
        238: '\u03B5',
        239: '\u2229',
        240: '\u2261',
        241: '\u00B1',
        242: '\u2265',
        243: '\u2264',
        244: '\u2320',
        245: '\u2321',
        246: '\u00F7',
        247: '\u2248',
        248: '\u00B0',
        249: '\u2219',
        250: '\u00B7',
        251: '\u221A',
        252: '\u207F',
        253: '\u00B2',
        254: '\u25A0',
        255: '\u00A0',
    }

    Ord = {
        '\u0000': 0,
        '\u263A': 1,
        '\u263B': 2,
        '\u2665': 3,
        '\u2666': 4,
        '\u2663': 5,
        '\u2660': 6,
        '\u2022': 7,
        '\u25D8': 8,
        '\u25CB': 9,
        '\u25D9': 10,
        '\u2642': 11,
        '\u2640': 12,
        '\u266A': 13,
        '\u266B': 14,
        '\u263C': 15,
        '\u25BA': 16,
        '\u25C4': 17,
        '\u2195': 18,
        '\u203C': 19,
        '\u00B6': 20,
        '\u00A7': 21,
        '\u25AC': 22,
        '\u21A8': 23,
        '\u2191': 24,
        '\u2193': 25,
        '\u2192': 26,
        '\u2190': 27,
        '\u221F': 28,
        '\u2194': 29,
        '\u25B2': 30,
        '\u25BC': 31,
        '\u0020': 32,
        '\u0021': 33,
        '\u0022': 34,
        '\u0023': 35,
        '\u0024': 36,
        '\u0025': 37,
        '\u0026': 38,
        '\u0027': 39,
        '\u0028': 40,
        '\u0029': 41,
        '\u002A': 42,
        '\u002B': 43,
        '\u002C': 44,
        '\u002D': 45,
        '\u002E': 46,
        '\u002F': 47,
        '\u0030': 48,
        '\u0031': 49,
        '\u0032': 50,
        '\u0033': 51,
        '\u0034': 52,
        '\u0035': 53,
        '\u0036': 54,
        '\u0037': 55,
        '\u0038': 56,
        '\u0039': 57,
        '\u003A': 58,
        '\u003B': 59,
        '\u003C': 60,
        '\u003D': 61,
        '\u003E': 62,
        '\u003F': 63,
        '\u0040': 64,
        '\u0041': 65,
        '\u0042': 66,
        '\u0043': 67,
        '\u0044': 68,
        '\u0045': 69,
        '\u0046': 70,
        '\u0047': 71,
        '\u0048': 72,
        '\u0049': 73,
        '\u004A': 74,
        '\u004B': 75,
        '\u004C': 76,
        '\u004D': 77,
        '\u004E': 78,
        '\u004F': 79,
        '\u0050': 80,
        '\u0051': 81,
        '\u0052': 82,
        '\u0053': 83,
        '\u0054': 84,
        '\u0055': 85,
        '\u0056': 86,
        '\u0057': 87,
        '\u0058': 88,
        '\u0059': 89,
        '\u005A': 90,
        '\u005B': 91,
        '\u005C': 92,
        '\u005D': 93,
        '\u005E': 94,
        '\u005F': 95,
        '\u0060': 96,
        '\u0061': 97,
        '\u0062': 98,
        '\u0063': 99,
        '\u0064': 100,
        '\u0065': 101,
        '\u0066': 102,
        '\u0067': 103,
        '\u0068': 104,
        '\u0069': 105,
        '\u006A': 106,
        '\u006B': 107,
        '\u006C': 108,
        '\u006D': 109,
        '\u006E': 110,
        '\u006F': 111,
        '\u0070': 112,
        '\u0071': 113,
        '\u0072': 114,
        '\u0073': 115,
        '\u0074': 116,
        '\u0075': 117,
        '\u0076': 118,
        '\u0077': 119,
        '\u0078': 120,
        '\u0079': 121,
        '\u007A': 122,
        '\u007B': 123,
        '\u007C': 124,
        '\u007D': 125,
        '\u007E': 126,
        '\u2302': 127,
        '\u00C7': 128,
        '\u00FC': 129,
        '\u00E9': 130,
        '\u00E2': 131,
        '\u00E4': 132,
        '\u00E0': 133,
        '\u00E5': 134,
        '\u00E7': 135,
        '\u00EA': 136,
        '\u00EB': 137,
        '\u00E8': 138,
        '\u00EF': 139,
        '\u00EE': 140,
        '\u00EC': 141,
        '\u00C4': 142,
        '\u00C5': 143,
        '\u00C9': 144,
        '\u00E6': 145,
        '\u00C6': 146,
        '\u00F4': 147,
        '\u00F6': 148,
        '\u00F2': 149,
        '\u00FB': 150,
        '\u00F9': 151,
        '\u00FF': 152,
        '\u00D6': 153,
        '\u00DC': 154,
        '\u00A2': 155,
        '\u00A3': 156,
        '\u00A5': 157,
        '\u20A7': 158,
        '\u0192': 159,
        '\u00E1': 160,
        '\u00ED': 161,
        '\u00F3': 162,
        '\u00FA': 163,
        '\u00F1': 164,
        '\u00D1': 165,
        '\u00AA': 166,
        '\u00BA': 167,
        '\u00BF': 168,
        '\u2310': 169,
        '\u00AC': 170,
        '\u00BD': 171,
        '\u00BC': 172,
        '\u00A1': 173,
        '\u00AB': 174,
        '\u00BB': 175,
        '\u2591': 176,
        '\u2592': 177,
        '\u2593': 178,
        '\u2502': 179,
        '\u2524': 180,
        '\u2561': 181,
        '\u2562': 182,
        '\u2556': 183,
        '\u2555': 184,
        '\u2563': 185,
        '\u2551': 186,
        '\u2557': 187,
        '\u255D': 188,
        '\u255C': 189,
        '\u255B': 190,
        '\u2510': 191,
        '\u2514': 192,
        '\u2534': 193,
        '\u252C': 194,
        '\u251C': 195,
        '\u2500': 196,
        '\u253C': 197,
        '\u255E': 198,
        '\u255F': 199,
        '\u255A': 200,
        '\u2554': 201,
        '\u2569': 202,
        '\u2566': 203,
        '\u2560': 204,
        '\u2550': 205,
        '\u256C': 206,
        '\u2567': 207,
        '\u2568': 208,
        '\u2564': 209,
        '\u2565': 210,
        '\u2559': 211,
        '\u2558': 212,
        '\u2552': 213,
        '\u2553': 214,
        '\u256B': 215,
        '\u256A': 216,
        '\u2518': 217,
        '\u250C': 218,
        '\u2588': 219,
        '\u2584': 220,
        '\u258C': 221,
        '\u2590': 222,
        '\u2580': 223,
        '\u03B1': 224,
        '\u00DF': 225,
        '\u0393': 226,
        '\u03C0': 227,
        '\u03A3': 228,
        '\u03C3': 229,
        '\u00B5': 230,
        '\u03C4': 231,
        '\u03A6': 232,
        '\u0398': 233,
        '\u03A9': 234,
        '\u03B4': 235,
        '\u221E': 236,
        '\u03C6': 237,
        '\u03B5': 238,
        '\u2229': 239,
        '\u2261': 240,
        '\u00B1': 241,
        '\u2265': 242,
        '\u2264': 243,
        '\u2320': 244,
        '\u2321': 245,
        '\u00F7': 246,
        '\u2248': 247,
        '\u00B0': 248,
        '\u2219': 249,
        '\u00B7': 250,
        '\u221A': 251,
        '\u207F': 252,
        '\u00B2': 253,
        '\u25A0': 254,
        '\u00A0': 255,
    }